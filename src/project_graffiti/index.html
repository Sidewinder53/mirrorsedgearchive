{% set pageInfo = {
  name: 'project_graffiti',
  category: 'archives',
  title: 'Player Tag Generator',
  description: "Interactive Player Tage Generator",
  reqScripts: [ 'assets/js/project_graffiti.js', 'assets/vendor/image-picker/image-picker.js', 'assets/vendor/nouislider/nouislider.min.js', 'assets/vendor/wnumb/wNumb.min.js' ],
  reqStylesheets: [ 'assets/vendor/@mdi/materialdesignicons.min.css',  'assets/css/project_graffiti.css', 'assets/vendor/image-picker/image-picker.css', 'assets/vendor/nouislider/nouislider.min.css' ]
}%}

{%- extends "templates/_layout.njk" %}

{%- block content %}

<body>
  <div id="selector_area"></div>
  <button id="submit">Render image</button>
  <br>
  <img id="outputImage" style="background-color: black; border: solid 1px red; min-width: 514px; min-height: 514px;">
  <script type='module'>
    import { buildInputFile, execute } from '/assets/vendor/wasm-imagemagick/magickApi.js';
    var assetpack;
    var category;
    var groupEl;
    var assetStore = {};
    var cwd = [];

    function dec2hex(dec) {
      return ('0' + dec.toString(16)).substr(-2)
    }

    function getThumbExt(fileName) {
      let ext;
      if (category === 'background_select') {
        return fileName.replace('.png', '.jpg');
      } else {
        return fileName;
      }
    }

    // generateId :: Integer -> String
    function generateId(len) {
      var arr = new Uint8Array((len || 40) / 2)
      window.crypto.getRandomValues(arr)
      return Array.from(arr, dec2hex).join('')
    }

    function renderCategoryPicker(storeObject, type, manifest) {
      let selectTopEl = document.createElement("select");
      selectTopEl.setAttribute("id", "select-" + type.substring(0, type.length - 1));
      storeObject[type].content.forEach(categoryStoreEl => {
        let optgroupEl = document.createElement("optgroup");
        let optgroupId = (categoryStoreEl.label.substring(0, 4)).toLowerCase();
        optgroupEl.setAttribute("id", "sel-emb-" + optgroupId);
        optgroupEl.setAttribute("label", categoryStoreEl.label);
        categoryStoreEl.content.forEach(itemStoreEl => {
          let optionEl = document.createElement("option");
          optionEl.value = itemStoreEl.id;
          optionEl.text = itemStoreEl.label;
          if (categoryStoreEl.label == "_TOOL_") {
          optionEl.setAttribute("data-src-img", manifest["assets/media/image/project_graffiti/generic/" + itemStoreEl.path])
          } else {
          optionEl.setAttribute("data-src-img", manifest["assets/media/image/project_graffiti/thumbnails/" + type + "/" + itemStoreEl.path])
          optionEl.setAttribute("data-src-path", type + "/" + itemStoreEl.path)
          }
          optgroupEl.appendChild(optionEl);
        });
        selectTopEl.appendChild(optgroupEl);
        selectTopEl.appendChild(document.createElement("br"));
      });
      document.querySelector("#selector_area").appendChild(selectTopEl);
      document.querySelector("#selector_area").appendChild(document.createElement("hr"))
    }

    let DoMagickCall = async function () {
      // const fetchedFrame = await fetch("https://static.mirrorsedgearchive.de/prod/graffiti/frames/evolved_crusher.png");
      // const fetchedMask = await fetch("https://static.mirrorsedgearchive.de/prod/graffiti/frames/evolved_crusher.png");
      // const fetchedEmblem = await fetch("https://static.mirrorsedgearchive.de/prod/graffiti/frames/evolved_crusher.png");
      // const fetchedBackground = await fetch("https://static.mirrorsedgearchive.de/prod/graffiti/frames/evolved_crusher.png");

      // const frameSource = new Uint8Array(await fetchedFrame.arrayBuffer());
      // const maskSource = new Uint8Array(await fetchedMask.arrayBuffer());
      // const emblemSource = new Uint8Array(await fetchedEmblem.arrayBuffer());
      // const backgroundSource = new Uint8Array(await fetchedBackground.arrayBuffer());

      // const files = [
      //   { 'name': 'frame.png', 'content': frameSource },
      //   { 'name': 'mask.png', 'content': maskSource },
      //   { 'name': 'emblem.png', 'content': emblemSource },
      //   { 'name': 'background.png', 'content': backgroundSource }
      // ];

      // const commands = ["convert", "frame.png", "-rotate", '90', 'step1.png'];
      let baseUrl = "https://static.mirrorsedgearchive.de/prod/graffiti/"
      let frame_selector = document.querySelector("#select-frame");
      let frame = baseUrl + frame_selector[frame_selector.selectedIndex].getAttribute("data-src-path");
      console.log("ðŸ”§ Selected frame: " + frame);
      let emblem_selector = document.querySelector("#select-emblem");
      let emblem = baseUrl + emblem_selector[emblem_selector.selectedIndex].getAttribute("data-src-path");
      console.log("ðŸ”§ Selected emblem: " + emblem);
      let mask = baseUrl + "mask" + (emblem_selector[emblem_selector.selectedIndex].getAttribute("data-src-path")).substring(6);
      console.log("ðŸ”§ Selected mask: " + mask);
      let background_selector = document.querySelector("#select-background");
      let background = baseUrl + background_selector[background_selector.selectedIndex].getAttribute("data-src-path");
      console.log("ðŸ”§ Selected background: " + background);

      let step1Result = await execute({
        inputFiles: [await buildInputFile('https://static.mirrorsedgearchive.de/prod/graffiti/frames/evolved_crusher.png', 'frame.png')],
        commands: ['convert frame.png -alpha extract step1.png']
      });

      console.log('Step 1');
      console.log(await step1Result);

      let step2Result = await execute({
        inputFiles: [
          { name: 'step1.png', content: step1Result.outputFiles[0].buffer },
          await buildInputFile(mask, 'mask.png')
        ],
        commands: ['composite step1.png mask.png -compose Darken step2.png']
      });

      console.log('Step 2');
      console.log(await step2Result);

      let step3Result = await execute({
        inputFiles: [
          { name: 'step2.png', content: step2Result.outputFiles[0].buffer },
          await buildInputFile(frame, 'frame.png')
        ],
        commands: ['composite step2.png -compose CopyOpacity frame.png step3.png']
      });

      console.log('Step 3');
      console.log(await step3Result);

      let step4Result = await execute({
        inputFiles: [
          { name: 'step3.png', content: step3Result.outputFiles[0].buffer },
          await buildInputFile(emblem, 'emblem.png')
        ],
        commands: ['composite step3.png emblem.png -resize 512 step4.png']
      });

      console.log('Step 4');
      console.log(await step4Result);

      let step5prepResult = await execute({
        inputFiles: [
          await buildInputFile(background, 'background.png')
        ],
        commands: ['convert background.png -gravity center -resize 1024x1024 -extent 1024x1024 step5prepare.png']
      });

      console.log('Step 5 prep');
      console.log(await step5prepResult);

      let step5Result = await execute({
        inputFiles: [
          { name: 'step4.png', content: step4Result.outputFiles[0].buffer },
          { name: 'step5prep.png', content: step5prepResult.outputFiles[0].buffer },
          await buildInputFile(background, 'background.png')
        ],
        commands: ['composite -gravity center step4.png step5prep.png step5.png']
      });

      console.log('Step 5');
      console.log(await step5Result);

      // let processedFiles = await Magick.Call(files, commands);
      let outputImage = new Blob([step5Result.outputFiles[0].buffer], { type: "image/png" });
      var urlCreator = window.URL || window.webkitURL;
      var imageUrl = urlCreator.createObjectURL(outputImage);
      var img = document.querySelector("#outputImage");
      img.src = imageUrl;


      // let firstOutputImage = processedFiles[0];
      // console.log("created image");
      // const outputImage = document.getElementById('outputImage');
      // outputImage.src = URL.createObjectURL(firstOutputImage['blob']);
    }

    // Main Thread
    $.getJSON("/assets/rev-manifest.json", function (manifest) {
      $.getJSON("./assets.json", function (assetStore) {
        renderCategoryPicker(assetStore, "emblems", manifest);
        renderCategoryPicker(assetStore, "frames", manifest);
        renderCategoryPicker(assetStore, "backgrounds", manifest);
      });
    });
    document.querySelector("#submit").addEventListener("click", function() {
      DoMagickCall();
    })
  </script>
  {% endblock %}
